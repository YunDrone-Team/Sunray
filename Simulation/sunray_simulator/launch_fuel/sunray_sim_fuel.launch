<launch>

    <!-- size of map, change the size in x, y, z according to your application -->
    <arg name="map_size_x" value="45.0"/>
    <arg name="map_size_y" value="45.0"/>
    <arg name="map_size_z" value=" 5.0"/>

    <arg name="box_min_x" value="-10.0"/>
    <arg name="box_min_y" value="-15.0"/>
    <arg name="box_min_z" value=" 0.0"/>
    <arg name="box_max_x" value="10.0"/>
    <arg name="box_max_y" value="15.0"/>
    <arg name="box_max_z" value=" 2.0"/>

    <arg name="init_x" value="0"/>
    <arg name="init_y" value="0"/>
    <arg name="init_z" value="1.2"/>

    <!-- 局部坐标系下的点云话题 -->
    <arg name="local_pointcloud_topic_1" default="/uav1/livox/lidar"/>
    <!-- 转换出来的世界坐标系下的点云话题 -->
    <arg name="global_pointcloud_topic" default="/uav1/global_points"/>
    <arg name="world_frame" default="world"/>

    <!-- topic of your odometry such as VIO or LIO -->
    <arg name="odom_topic" value="/uav1/sunray/gazebo_pose" />
    <arg name="sensor_pose_topic" value="/uav1/mavros/local_position/pose"/>
    <!-- subscribe ONLY TO ONE of the two topics -->
    <arg name="depth_topic" value="nouse2"/>
    <arg name="cloud_topic" default="$(arg global_pointcloud_topic)"/>

    <!-- maximum velocity and acceleration the drone will reach -->
    <arg name="max_vel" value="1.0" />
    <arg name="max_acc" value="1.0" />

    <!-- intrinsic params of the depth camera -->
    <arg name="cx" value="321.04638671875"/>
    <arg name="cy" value="243.44969177246094"/>
    <arg name="fx" value="387.229248046875"/>
    <arg name="fy" value="387.229248046875"/>

    <!-- main algorithm params -->
    <!-- main node -->
    <node pkg="exploration_manager" name="exploration_node" type="exploration_node" output="screen">
        <remap from ="/odom_world" to="$(arg odom_topic)"/>
        <remap from ="/map_ros/pose"   to = "$(arg sensor_pose_topic)"/>
        <remap from ="/map_ros/depth" to = "$(arg depth_topic)"/>
        <remap from ="/map_ros/cloud" to="$(arg cloud_topic)"/>

        <param name="sdf_map/resolution" value="0.1" />
        <param name="sdf_map/map_size_x" value="$(arg map_size_x)" />
        <param name="sdf_map/map_size_y" value="$(arg map_size_y)" />
        <param name="sdf_map/map_size_z" value="$(arg map_size_z)" />
        <!-- <param name="sdf_map/obstacles_inflation" value="0.099" />  -->
        <param name="sdf_map/obstacles_inflation" value="0.35" />
        <param name="sdf_map/local_bound_inflate" value="0.5"/>
        <param name="sdf_map/local_map_margin" value="50"/>
        <param name="sdf_map/ground_height" value="0.0"/>
        <param name="sdf_map/default_dist" value="0.0"/>

        <param name="sdf_map/p_hit" value="0.65"/>
        <param name="sdf_map/p_miss" value="0.35"/>
        <param name="sdf_map/p_min" value="0.12"/>
        <param name="sdf_map/p_max" value="0.90"/>
        <param name="sdf_map/p_occ" value="0.80"/>
        <param name="sdf_map/min_ray_length" value="0.5"/>
        <param name="sdf_map/max_ray_length" value="4.5"/>
        <param name="sdf_map/virtual_ceil_height" value="-10"/>
        <param name="sdf_map/optimistic" value="false" type="bool"/>
        <param name="sdf_map/signed_dist" value="false" type="bool"/>
        <param name="sdf_map/box_min_x" value="$(arg box_min_x)" type="double"/>
        <param name="sdf_map/box_min_y" value="$(arg box_min_y)" type="double"/>
        <param name="sdf_map/box_min_z" value="$(arg box_min_z)" type="double"/>
        <param name="sdf_map/box_max_x" value="$(arg box_max_x)" type="double"/>
        <param name="sdf_map/box_max_y" value="$(arg box_max_y)" type="double"/>
        <param name="sdf_map/box_max_z" value="$(arg box_max_z)" type="double"/>

        <param name="map_ros/cx" value="$(arg cx)"/>
        <param name="map_ros/cy" value="$(arg cy)"/>
        <param name="map_ros/fx" value="$(arg fx)"/>
        <param name="map_ros/fy" value="$(arg fy)"/>
        <param name="map_ros/depth_filter_maxdist" value="5.0"/>
        <param name="map_ros/depth_filter_mindist" value="0.2"/>
        <param name="map_ros/depth_filter_margin" value="2"/>
        <param name="map_ros/k_depth_scaling_factor" value="1000.0"/>
        <param name="map_ros/skip_pixel" value="2"/>
        <param name="map_ros/esdf_slice_height" value="0.3"/>
        <param name="map_ros/visualization_truncate_height" value="10.09"/>
        <param name="map_ros/visualization_truncate_low" value="-2.0"/>
        <param name="map_ros/show_occ_time" value="false"/>
        <param name="map_ros/show_esdf_time" value="false"/>
        <param name="map_ros/show_all_map" value="true"/>
        <param name="map_ros/frame_id" value="world"/>

        <!-- Fsm -->
        <param name="fsm/thresh_replan1" value="0.5" type="double"/>
        <param name="fsm/thresh_replan2" value="0.5" type="double"/>
        <param name="fsm/thresh_replan3" value="1.5" type="double"/>

        <!-- <param name="fsm/thresh_replan1" value="0.00001" type="double"/> -->
        <!-- <param name="fsm/thresh_replan2" value="100.0" type="double"/> -->
        <!-- <param name="fsm/thresh_replan3" value="0.1" type="double"/> -->
        <param name="fsm/replan_time" value="0.200" type="double"/>

        <!-- Exploration manager -->

        <param name="exploration/refine_local" value="true" type="bool"/>
        <param name="exploration/refined_num" value="7" type="int"/>
        <param name="exploration/refined_radius" value="5.0" type="double"/>
        <param name="exploration/max_decay" value="0.8" type="double"/>
        <param name="exploration/top_view_num" value="15" type="int"/>
        <param name="exploration/vm" value="$(eval 1.0 * arg('max_vel'))" type="double"/>
        <param name="exploration/am" value="$(eval 1.0 * arg('max_acc'))" type="double"/>
        <param name="exploration/yd" value="$(eval 60 * 3.1415926 / 180.0)" type="double"/>
        <param name="exploration/ydd" value="$(eval 90 * 3.1415926 / 180.0)" type="double"/>
        <param name="exploration/w_dir" value="1.5" type="double"/>
        <param name="exploration/tsp_dir" value="$(find lkh_tsp_solver)/resource" type="string"/>
        <param name="exploration/relax_time" value="1.0" type="double"/>

        <param name="frontier/cluster_min" value="100" type="int"/>
        <param name="frontier/cluster_size_xy" value="2.0" type="double"/>
        <param name="frontier/cluster_size_z" value="10.0" type="double"/>
        <param name="frontier/min_candidate_dist" value="0.75" type="double"/>
        <param name="frontier/min_candidate_clearance" value="0.21" type="double"/>
        <param name="frontier/candidate_dphi" value="$(eval 15 * 3.1415926 / 180.0)" type="double"/>
        <param name="frontier/candidate_rnum" value="3" type="int"/>
        <param name="frontier/candidate_rmin" value="1.5" type="double"/>
        <param name="frontier/candidate_rmax" value="2.5" type="double"/>
        <param name="frontier/down_sample" value="3" type="int"/>
        <param name="frontier/min_visib_num" value="15" type="int"/>
        <param name="frontier/min_view_finish_fraction" value="0.2" type="double"/>

        <!-- Perception utils -->
        <param name="perception_utils/top_angle" value="0.56125" type="double"/>
        <param name="perception_utils/left_angle" value="0.69222" type="double"/>
        <param name="perception_utils/right_angle" value="0.68901" type="double"/>
        <param name="perception_utils/max_dist" value="4.5" type="double"/>
        <param name="perception_utils/vis_dist" value="1.0" type="double"/>


        <param name="heading_planner/yaw_diff" value="$(eval 30 * 3.1415926 / 180.0)" type="double"/>
        <param name="heading_planner/half_vert_num" value="5" type="int"/>
        <param name="heading_planner/lambda1" value="2.0" type="double"/>
        <param name="heading_planner/lambda2" value="1.0" type="double"/>
        <param name="heading_planner/max_yaw_rate" value="$(eval 10 * 3.1415926 / 180.0)" type="double"/>
        <param name="heading_planner/w" value="20000.0" type="double"/>
        <param name="heading_planner/weight_type" value="1" type="double"/>

        <!-- planner manager -->
        <!-- <param name="manager/max_vel" value="$(arg max_vel)" type="double"/> -->
        <param name="manager/max_vel" value="$(arg max_vel)" type="double"/>
        <param name="manager/max_acc" value="$(arg max_acc)" type="double"/>
        <param name="manager/max_jerk" value="4" type="double"/>
        <param name="manager/dynamic_environment" value="0" type="int"/>
        <param name="manager/local_segment_length" value="6.0" type="double"/>
        <param name="manager/clearance_threshold" value="0.2" type="double"/>
        <param name="manager/control_points_distance" value="0.35" type="double"/>
        <param name="manager/use_geometric_path" value="true" type="bool"/>
        <param name="manager/use_kinodynamic_path" value="true" type="bool"/>
        <param name="manager/use_topo_path" value="true" type="bool"/>
        <param name="manager/use_optimization" value="true" type="bool"/>
        <param name="manager/use_active_perception" value="true" type="bool"/>
        <param name="manager/min_time" value="true" type="bool"/>

        <!-- kinodynamic path searching -->
        <param name="search/max_tau" value="0.8" type="double"/>
        <param name="search/init_max_tau" value="1.0" type="double"/>
        <param name="search/max_vel" value="$(arg max_vel)" type="double"/>
        <param name="search/vel_margin" value="0.25" type="double"/>
        <param name="search/max_acc" value="$(arg max_acc)" type="double"/>
        <param name="search/w_time" value="10.0" type="double"/>
        <param name="search/horizon" value="5.0" type="double"/>
        <param name="search/lambda_heu" value="10.0" type="double"/>
        <param name="search/resolution_astar" value="0.025" type="double"/>
        <param name="search/time_resolution" value="0.8" type="double"/>
        <param name="search/margin" value="0.2" type="double"/>
        <param name="search/allocate_num" value="100000" type="int"/>
        <param name="search/check_num" value="10" type="int"/>
        <param name="search/optimistic" value="false" type="bool"/>

        <param name="astar/lambda_heu" value="10000.0" type="double"/>
        <param name="astar/resolution_astar" value="0.2" type="double"/>
        <param name="astar/allocate_num" value="1000000" type="int"/>
        <param name="astar/max_search_time" value="0.001" type="double"/>

        <!-- trajectory optimization -->
        <param name="optimization/ld_smooth" value="20.0" type="double"/>
        <param name="optimization/ld_dist" value="10.0" type="double"/>
        <param name="optimization/ld_feasi" value="2.0" type="double"/>
        <param name="optimization/ld_start" value="100.0" type="double"/>
        <param name="optimization/ld_end" value="0.5" type="double"/>
        <param name="optimization/ld_guide" value="1.5" type="double"/>
        <param name="optimization/ld_waypt" value="0.3" type="double"/>
        <param name="optimization/ld_view" value="0.0" type="double"/>
        <param name="optimization/ld_time" value="1.0" type="double"/>
        <param name="optimization/dist0" value="0.7" type="double"/>
        <param name="optimization/max_vel" value="$(arg max_vel)" type="double"/>
        <param name="optimization/max_acc" value="$(arg max_acc)" type="double"/>
        <param name="optimization/algorithm1" value="15" type="int"/>
        <param name="optimization/algorithm2" value="11" type="int"/>
        <param name="optimization/max_iteration_num1" value="2" type="int"/>
        <param name="optimization/max_iteration_num2" value="2000" type="int"/>
        <param name="optimization/max_iteration_num3" value="200" type="int"/>
        <param name="optimization/max_iteration_num4" value="200" type="int"/>

        <param name="optimization/max_iteration_time1" value="0.0001" type="double"/>
        <param name="optimization/max_iteration_time2" value="0.005" type="double"/>
        <param name="optimization/max_iteration_time3" value="0.003" type="double"/>
        <param name="optimization/max_iteration_time4" value="0.003" type="double"/>
        <param name="bspline/limit_vel" value="$(arg max_vel)" type="double"/>
        <param name="bspline/limit_acc" value="$(arg max_acc)" type="double"/>
        <param name="bspline/limit_ratio" value="1.1" type="double"/>
        <param name="bspline/limit_vel" value="$(arg max_vel)" type="double"/>
        <param name="bspline/limit_acc" value="$(arg max_acc)" type="double"/>
        <param name="bspline/limit_ratio" value="1.1" type="double"/>

    </node>

    <!-- trajectory server -->
    <node pkg="plan_manage" name="traj_server" type="traj_server" output="screen">
        <!-- <remap from="/position_cmd" to="planning/pos_cmd"/> -->
        <remap from="/position_cmd" to="/uav1/pos_cmd"/>

        <remap from="/odom_world" to="$(arg odom_topic)"/>
        <param name="traj_server/time_forward" value="1.5" type="double"/>
        <param name="traj_server/pub_traj_id" value="4" type="int"/>
        <param name="traj_server/init_x" value="$(arg init_x)" type="double"/>
        <param name="traj_server/init_y" value="$(arg init_y)" type="double"/>
        <param name="traj_server/init_z" value="$(arg init_z)" type="double"/>

        <param name="perception_utils/top_angle" value="0.56125" type="double"/>
        <param name="perception_utils/left_angle" value="0.69222" type="double"/>
        <param name="perception_utils/right_angle" value="0.68901" type="double"/>
        <param name="perception_utils/max_dist" value="4.5" type="double"/>
        <param name="perception_utils/vis_dist" value="1.0" type="double"/>


    </node>

    <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
        <remap from="~odom" to="$(arg odom_topic)"/>
        <remap from="~goal" to="/move_base_simple/goal"/>
        <remap from="~traj_start_trigger" to="/traj_start_trigger" />
        <param name="waypoint_type" value="point"/>
    </node>

    <!-- posintionCmd 输出转换为sunray控制指令 -->
    <!--  posintionCmd话题 -->
    <arg name="cmd_sub_topic_1" default="/uav1/pos_cmd"/>
    <arg name="control_pub_topic_1" default="/uav1/sunray/uav_control_cmd"/>
    <arg name="control_type" default="2"/>
    <arg name="enable_yaw" default="true"/>
    <node name="positionCmd2sunray_node_1" pkg="sunray_planner_utils" type="positionCmd2sunray" output="screen">
        <param name="cmd_sub_topic" value="$(arg cmd_sub_topic_1)"/>
        <param name="control_pub_topic" value="$(arg control_pub_topic_1)"/>
        <param name="control_type" value="$(arg control_type)"/>
        <param name="enable_yaw" value="$(arg enable_yaw)"/>
    </node>

    <!-- 点云转换为世界坐标系 -->
    <!-- 局部坐标系下的点云的frame_id -->
    <arg name="child_frame_1" default="uav1/livox_laser"/>
    <node name="point_cloud_transform_1" pkg="sunray_planner_utils" type="point_cloud_transform" output="screen">
        <param name="input_point_topic" value="$(arg local_pointcloud_topic_1)" />
        <param name="output_point_topic" value="$(arg global_pointcloud_topic)" />
        <param name="odom_topic" value="$(arg odom_topic)" />
        <param name="frame_id" value="$(arg world_frame)" />
        <param name="child_frame_id" value="$(arg child_frame_1)" />
    </node>

    <!-- 如果使用mid360且数据格式不为pointcloud的话需要进行转换 -->
    <!-- <include file="$(find sunray_planner_utils)/launch/livox2point.launch"></include> -->

    <arg name="enable_rviz" default="true"/>
    <arg name="rivz_config" default="$(find sunray_simulator)/launch_rviz/fuel_sim.rviz"/>
    <group if="$(arg enable_rviz)">
        <node type="rviz" name="rviz_sim" pkg="rviz" args="-d $(arg rivz_config)"/>
    </group>

</launch>
